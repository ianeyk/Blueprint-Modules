---
title: "RSQLite Example Queries"
author: "Ian Eykamp"
date: "11/29/2021"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

## 4.2.2 Connect to the Database

To start, create a connection to the database. Copy, paste, and run this
command in RStudio:

```{r}
# install.packages("RSQLite") # comment this line out if RSQLite is already installed
library(RSQLite)

conn <- dbConnect(
  drv = RSQLite::SQLite(), 
  dbname = "C:/dev/sensorbot/sensorbot.db"
) 
```

Note, SQL code is different from our other codes: users cannot type SQL
code directly into RStudio. It needs to be in quotations and inside of
parentheses after the command of `dbGetQuery`; see the blue highlight in
the code as an example. Make every query with the `dbGetQuery` function
with `conn` as the first argument, like so:

```{r}
dbGetQuery(conn, "SELECT * FROM device LIMIT 10")
```

## 4.2.3 Make Table Command

Note the following definitions for the Make a Table command:

-   `table_name`: Name of the table to be created.
-   `column1`: Name of the first column and so on.
-   `data_type`: Type of data that can be stored in the field.
-   `size`: Size of the data that can be stored in a column. For
    example, in a column, if you give the data_type as `varchar` and
    size as 20, that column can store a string of 20 characters,
    maximum.
-   `constraint_name`: Name of the constraint. For example, `NOT NULL`,
    `UNIQUE`, `PRIMARY KEY`.

The following example is a box of template code. Running this will
result in errors because terms like `data_type` and `constraint_name`
need to be defined. Keep reading, and you'll find an example you can

Template:

```{r eval=FALSE}
dbGetQuery(conn, "

CREATE TABLE table_name ( 
  column1 data_type(size) constraint_name,
  column2 data_type(size) constraint_name, 
  column3 data_type(size) constraint_name, 
  .... 
)

")
```

Example:

```{r}
dbGetQuery(conn, "

CREATE TABLE ts_kv_hourly ( 
  entity_id STRING NOT NULL, 
  key INT NOT NULL,
  ts INT NOT NULL, 
  val FLOAT NOT NULL, 
)

")
```

## 4.2.4 Select from Table Command

Follow the same process for the Select from Table command. Review this
template code to understand the pieces that go into the code needed to
select from a table (like the table you just created using the template
code).

Template:

```{r eval=FALSE}
dbGetQuery(conn, "

SELECT column1, column2 FROM table_name

")
```

Remember, in SQL, `*` means "everything." Visit these helpful videos if
you haven't already. Now, copy, paste, and run the following example in
RStudio.

Example:

```{r}
dbGetQuery(conn, "

SELECT * FROM device

")
```

Notice how every column appears and many rows do as well? What part of
this example query is causing all columns and rows to be returned?

Now `SELECT` the first two columns from `ts_kv_dictionary`. What are the
column names?

Hint: to find the column names, scroll to the top of the `SELECT *`
output.

## 4.2.5 Insert Data Command

To understand how the Insert Data command is built, review this
template. Afterward, copy, paste, and run the example template in
RStudio to see the results. Note the following definitions:

-   `table_name`: The name of the table.

-   `value1`, `value2`, `â€¦`: The value of the first column, second
    column, and so on, for the new record.

Template:

```{r eval=FALSE}
dbGetQuery(conn, "

INSERT INTO table_name VALUES (value1, value2, value3,...)

")
```

Example:

```{r}
dbGetQuery(conn, "

INSERT INTO ts_kv_dictionary VALUES ('rain', '23')

")
```

This added a row for "rain" into our dictionary, with a key
identification (`key_id`) of 23. Now try this function again, but add a
row for "wildfire" and label that `key_id` as "24."

## 4.2.6 Where Clause Command

To understand how the Where Clause command is constructed, review this
template. Afterward, copy, paste, and run the example template in
RStudio to see the results. Note the following definitions:

-   `column1` , `column2`: Fields in the table.

-   `tableName`: Name of the table.

-   `column_name`: Name of the field.

-   `operator`: Operation to be performed for filtering.

-   `value`: The exact value to get related data in a result.

Table 4-1 defines the operators that apply to the Where Clause Command.

| Operator |                Description                 |
|:--------:|:------------------------------------------:|
|    \>    |                greater than                |
|   \>=    |          greater than or equal to          |
|    \<    |                 less than                  |
|   \<=    |           less than or equal to            |
|    =     |                  equal to                  |
|   \<\>   |                not equal to                |
| BETWEEN  |           in an inclusive range            |
|   LIKE   |            search for a pattern            |
|    IN    | define multiple likely values for a column |

Template:

```{r eval=FALSE}
dbGetQuery(conn, "

SELECT column1,column2 FROM TableName WHERE column_name operator value;

")
```

Example:

```{r}
dbGetQuery(conn, "

SELECT \* FROM ts_kv_hourly WHERE key = 10

")
```

## 4.2.7 Min/Max Values Command

To understand how the Min/Max Values command is built, review this
template. Afterward, copy, paste, and run the example template in
RStudio to see the results. Template:

```{r eval=FALSE}
dbGetQuery(conn, "

SELECT max(val) 
FROM TableName 
WHERE column_name operator value; 

")
```

Example:

```{r}
dbGetQuery(conn, "

SELECT max(val) 
FROM ts_kv_hourly 
WHERE key = 7 

")
```

## 4.2.8 Count Number of Entries (Total) Command To understand how the

Count Number of Entries (Total) command is built, review this template.
Afterward, copy, paste, and run the example template in RStudio to see
the results.

Template:

```{r}
dbGetQuery(conn, "

SELECT COUNT(*) AS total 
FROM table_name 
WHERE column_name operator value; 
 
")
```

Example:

```{r}
dbGetQuery(conn, "

SELECT COUNT(*) AS total 
FROM ts_kv_hourly 
WHERE key = 7 OR 10 AND val > 500 

")
```

## 4.2.9 Combination Queries Command In this section, we will cover six

ways to use Combination Queries to pull data that match multiple search
criteria. This will combine the queries we covered in previous sections
(4.2.3 to 4.2.8)

1.  Count the number of readings where the particulate matter (PM)2.5 is
    greater than 500.

```{r}
dbGetQuery(conn, "

SELECT COUNT(*) AS total 
FROM ts_kv_hourly 
WHERE key = 10 AND val > 500

")
```

2.  Select the PM2.5 and the temperature for September 10 to 30, 2020.

```{r eval=FALSE}
dbGetQuery(conn, "

SELECT * FROM ts_kv_hourly 
WHERE key = 13 OR 16 AND 
ts BETWEEN _____ AND _____

")
```

Since the timestamp format is given in epoch milliseconds, for the
BETWEEN values, use this website (Epoch time) to convert the time range
to epoch timestamps and copy the Timestamp in milliseconds result to
your query.

For example, if you want to see only the data from between September 5
and 10, 2020, your last line would be: \`ts BETWEEN 159928200000 AND
1599721200000;

3.  Covert timestamp to datetime format.

```{r}
dbGetQuery(conn, "

SELECT * FROM ts_kv_hourly 
WHERE key = 13 OR 16 AND 
datetime(round(ts / 1000), 'unixepoch', 'localtime') 
BETWEEN 2020-09-10 00:00:00 AND 2020-09-30 23:59:59

")
```

4.  Find the identification codes for each device managed by the
    Department of Environmental Quality (DEQ).

    Hint: They will be designated under a specific table

```{r}
dbGetQuery(conn, "

SELECT DISTINCT entity_id 
FROM ts_kv_deq

")
```

5.  Select the data from days where the temperature exceeded 90 degrees
    Fahrenheit (F).

```{r}
dbGetQuery(conn, "

SELECT * FROM ts_kv 
WHERE key = 16 AND dbl_v > (90-32) * 5/9; 

")
```

6.  Select maximum or minimum readings for PM10 for October 31, 2020.

```{r}
dbGetQuery(conn, "

SELECT max(val) FROM ts_kv_hourly 
WHERE key = 7 AND 
datetime(round(ts / 1000), 'unixepoch', 'localtime') 
BETWEEN 2020-10-30 00:00:00 AND 2020-09-30 01:01:01; 

")
```
